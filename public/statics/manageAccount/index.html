<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100vh;
            width: 100vw;
        }

        .model {
            display: none;
            position: absolute;
            height: 100vh;
            width: 100vw;
            top: 0;
            left: 0;
            background-color: #000000AA;

        }

        .model>div {
            width: 30rem;
        }
    </style>
</head>

<body class="bg-gray-100 h-full">
    <header class="bg-white shadow p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded">Log Out</button>
    </header>

    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white p-4">
            <nav>
                <ul>
                    <li><a href="/statics/admin/index.html" class="block py-2">Manage Books</a></li>
                    <li><a href="/statics/manageAccount/index.html" class="block py-2">Manage Users</a></li>
                    <li>
                        <a href="/statics/pickups/pickups.html" class="block py-2 hover:bg-gray-700 rounded">
                            Manage
                            Pickups
                        </a>
                    </li>
                    <li>
                        <a href="/statics/returns/returns.html" class="block py-2 hover:bg-gray-700 rounded">
                            Manage
                            Returns
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-6">
            <div class="flex justify-between w-full content-center flex-wrap h-16">
                <h1 class="text-2xl font-bold">User Accounts</h1>
                <button class="bg-green-500 text-white px-10 py-1 rounded h-10 font-semibold"
                    onclick="createUser()">Create</button>
            </div>

            <!-- User Account Table -->
            <div class="overflow-x-auto bg-white shadow rounded-lg p-4">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Name</th>
                            <th class="px-4 py-2 text-left">Email</th>
                            <th class="px-4 py-2 text-left">Status</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody">
                        <!-- Rows will be dynamically generated by JS -->
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="mt-4 flex justify-between items-center">
                    <button id="prevBtn" class="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50"
                        disabled>Previous</button>
                    <span id="pageInfo" class="text-sm">Page 1 of 1</span>
                    <button id="nextBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Next</button>
                </div>
            </div>
        </main>

    </div>
    <div class="model">
        <div class="bg-white place-content-center rounded p-6 flex-col m-auto mt-32">
            <div class="flex justify-between">
                <h1 class="font-bold text-2xl mb-6">Sign Up</h1>
                <button class="bg-red-500 text-white px-4 py-2 rounded h-10 font-semibold"
                    onclick="document.querySelector('.model').style.display = 'none'">Close</button>
            </div>
            <div class="flex">
                <form class="space-y-4" id="signupForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="email" class="block text-gray-700 mb-1">Email</label>
                            <input type="email" id="email" placeholder="Enter email"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="username" class="block text-gray-700 mb-1">Username</label>
                            <input type="text" id="username" placeholder="Enter username"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="password" class="block text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" placeholder="Enter password" disabled
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="name" class="block text-gray-700 mb-1">Name</label>
                            <input type="text" id="name" placeholder="Enter your name"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="id" class="block text-gray-700 mb-1">ID</label>
                            <input type="text" id="id" placeholder="Enter your ID"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>

                        <div>
                            <label for="phone" class="block text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="phone" placeholder="Enter your phone number"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-gray-700 mb-1">Gender</label>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="gender" value="Male"
                                        class="text-blue-500 focus:ring-blue-500">
                                    <span class="ml-2">Male</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="gender" value="Female"
                                        class="text-blue-500 focus:ring-blue-500">
                                    <span class="ml-2">Female</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- Submit Button -->
                    <button type="submit"
                        class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition">CREATE</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function loadUsers() {
            fetch('http://localhost:5000/api/users')
                .then(response => response.json())
                .then(data => {
                    renderTable(data, currentPage);
                });
        }

        // Pagination variables
        const itemsPerPage = 10;
        let currentPage = 1;

        // Functions to render the table and handle pagination
        function renderTable(data, page) {
            const startIdx = (page - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageData = data.slice(startIdx, endIdx);

            const tableBody = document.getElementById('accountTableBody');
            tableBody.innerHTML = '';
            console.log(pageData.length);
            pageData.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">${account.id}</td>
                    <td class="px-4 py-2">${account.name}</td>
                    <td class="px-4 py-2">${account.email}</td>
                    <td class="px-4 py-2">${account.isBanned.toString() === 'false' ? 'Active' : 'Banned'}</td>
                    <td class="px-4 py-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteUser(${account.id})">Delete</button>
                        <button class="bg-yellow-500 text-white px-2 py-1 rounded">${account.isBanned.toString() === 'true' ? 'Unban' : 'Ban'}</button>
                    </td>
                `;
                const banButton = row.querySelector('button.bg-yellow-500');
                banButton.addEventListener('click', () => toggleBanUser(account.id, account.isBanned.toString() == "true" ? false : true));
                tableBody.appendChild(row);
            });

            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `Page ${page} of ${Math.ceil(data.length / itemsPerPage)}`;

            // Enable/Disable pagination buttons
            document.getElementById('prevBtn').disabled = page === 1;
            document.getElementById('nextBtn').disabled = page === Math.ceil(data.length / itemsPerPage);
        }

        // Pagination Button Handlers
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable(accountData, currentPage);
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentPage < Math.ceil(accountData.length / itemsPerPage)) {
                currentPage++;
                renderTable(accountData, currentPage);
            }
        });

        // Dummy actions for Create, Delete, and Ban/Unban
        function createUser() {
            document.querySelector('.model').style.display = 'block';
        }
        async function submit(event) {
            event.preventDefault();
            event.stopPropagation();
            // Lấy giá trị từ các trường đầu vào
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const password = "123456"; // Mặc định mật khẩu
            const name = document.getElementById('name').value;
            const id = document.getElementById('id').value;
            const phone = document.getElementById('phone').value;
            const isBanned = "false";
            // Lấy giá trị gender
            const gender = document.querySelector('input[name="gender"]:checked')?.value;

            // Kiểm tra thông tin đầu vào
            if (!email || !username || !password || !gender || !name || !id || !phone) {
                alert('Please fill all fields');
                return;
            }

            // Chuẩn bị dữ liệu để gửi đến API
            const userData = {
                email: email,
                username: username,
                password: password,
                name: name,
                id: id,
                phone: phone,
                gender: gender,
                isBanned: isBanned // Thêm isBanned vào đối tượng userData
            };


            try {
                // Gửi yêu cầu POST tới API
                response = await fetch('http://localhost:5000/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                console.log("Here done the fetching")
                // Kiểm tra phản hồi từ API
                if (response.ok) {
                    const result = await response.json();
                    alert('Create user successfully');
                    document.querySelector('.model').style.display = 'none';
                    loadUsers(); // Reload the list of users
                } else {
                    const error = await response.json();
                    console.log(error);
                    alert(`Error: ${error.message || 'Something went wrong'}`);
                }
            } catch (err) {
                console.error('Error:', err.message);
                alert('An error occurred. Please try again later.');
            }

        }
        document.getElementById('signupForm').addEventListener('submit', (event) => submit(event));

        //Delete user
        async function deleteUser(username) {
            try {
                const response = await fetch(`http://localhost:5000/api/users/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers(); // Reload the list of users
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message || 'Something went wrong'}`);
                }
            } catch (err) {
                console.error('Error deleting user:', err);
                alert('An error occurred. Please try again later.');
            }
        }

        // Toggle ban status of a user
        async function toggleBanUser(id, value) {
            try {

                // Gửi yêu cầu PATCH để cập nhật trạng thái isBanned của người dùng
                const response = await fetch(`http://localhost:5000/api/users/${id}?value=${value}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    alert('User ban status updated successfully!');
                    loadUsers(); // Reload the list of users
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message || 'Something went wrong'}`);
                }
            } catch (err) {
                console.error('Error toggling ban status:', err);
                alert('An error occurred. Please try again later.');
            }
        }


        // Initial render
        loadUsers();
    </script>
</body>

</html>